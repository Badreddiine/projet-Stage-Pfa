groups:
  # ========================================
  # ALERTES GÃ‰NÃ‰RALES - DISPONIBILITÃ‰
  # ========================================
  - name: service_availability
    rules:
      # Service indisponible
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "ğŸš¨ Service {{ $labels.job }} est DOWN"
          description: "Le service {{ $labels.job }} ({{ $labels.application }}) est indisponible depuis plus d'1 minute"

      # Service instable (flapping)
      - alert: ServiceFlapping
        expr: changes(up[5m]) > 3
        for: 2m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "âš ï¸ Service {{ $labels.job }} est instable"
          description: "Le service {{ $labels.job }} a redÃ©marrÃ© {{ $value }} fois en 5 minutes"

  # ========================================
  # ALERTES PERFORMANCES - MICROSERVICES
  # ========================================
  - name: microservices_performance
    rules:
      # CPU Ã©levÃ©
      - alert: HighCpuUsage
        expr: system_cpu_usage > 0.85
        for: 3m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "ğŸ”¥ CPU Ã©levÃ© sur {{ $labels.job }}"
          description: "CPU usage: {{ $value | humanizePercentage }} sur {{ $labels.job }}"

      # MÃ©moire JVM Ã©levÃ©e
      - alert: HighJvmMemoryUsage
        expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.85
        for: 3m
        labels:
          severity: warning
          team: development
        annotations:
          summary: "ğŸ§  MÃ©moire JVM Ã©levÃ©e sur {{ $labels.job }}"
          description: "MÃ©moire heap: {{ $value | humanizePercentage }} sur {{ $labels.job }}"

      # MÃ©moire critique
      - alert: CriticalJvmMemoryUsage
        expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.95
        for: 1m
        labels:
          severity: critical
          team: development
        annotations:
          summary: "ğŸ’€ MÃ‰MOIRE CRITIQUE sur {{ $labels.job }}"
          description: "MÃ©moire heap: {{ $value | humanizePercentage }} - RISQUE DE OutOfMemoryError!"

  # ========================================
  # ALERTES HTTP/API
  # ========================================
  - name: http_api_alerts
    rules:
      # Taux d'erreur HTTP Ã©levÃ©
      - alert: HighHttpErrorRate
        expr: (rate(http_server_requests_seconds_count{status=~"4..|5.."}[5m]) / rate(http_server_requests_seconds_count[5m])) > 0.1
        for: 2m
        labels:
          severity: warning
          team: development
        annotations:
          summary: "ğŸš« Taux d'erreur HTTP Ã©levÃ© sur {{ $labels.job }}"
          description: "{{ $value | humanizePercentage }} d'erreurs HTTP sur {{ $labels.job }} endpoint {{ $labels.uri }}"

      # Latence HTTP Ã©levÃ©e
      - alert: HighHttpLatency
        expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[5m])) > 2
        for: 3m
        labels:
          severity: warning
          team: development
        annotations:
          summary: "ğŸŒ Latence HTTP Ã©levÃ©e sur {{ $labels.job }}"
          description: "P95 latence: {{ $value }}s sur {{ $labels.job }} endpoint {{ $labels.uri }}"

  # ========================================
  # ALERTES BASE DE DONNÃ‰ES
  # ========================================
  - name: database_alerts
    rules:
      # Pas de connexions DB actives
      - alert: NoActiveDatabaseConnections
        expr: hikaricp_connections_active == 0
        for: 1m
        labels:
          severity: critical
          team: database
        annotations:
          summary: "ğŸ”Œ Aucune connexion DB active sur {{ $labels.job }}"
          description: "Le pool de connexions {{ $labels.pool }} n'a aucune connexion active"

      # Pool de connexions saturÃ©
      - alert: DatabaseConnectionPoolExhausted
        expr: (hikaricp_connections_active / hikaricp_connections_max) > 0.9
        for: 2m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "ğŸŠ Pool de connexions saturÃ© sur {{ $labels.job }}"
          description: "Pool {{ $labels.pool }}: {{ $value | humanizePercentage }} de connexions utilisÃ©es"

      # RequÃªtes lentes
      - alert: SlowDatabaseQueries
        expr: hikaricp_connections_usage_seconds{quantile="0.95"} > 5
        for: 2m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "ğŸ¢ RequÃªtes DB lentes sur {{ $labels.job }}"
          description: "P95 temps d'utilisation connexion: {{ $value }}s sur {{ $labels.job }}"

  # ========================================
  # ALERTES INFRASTRUCTURE SPÃ‰CIFIQUES
  # ========================================
  - name: infrastructure_alerts
    rules:
      # Config Server indisponible
      - alert: ConfigServerDown
        expr: up{job="config_server"} == 0
        for: 30s
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "ğŸ—ï¸ Config Server DOWN - Impact critique!"
          description: "Le Config Server est indisponible - tous les services peuvent Ãªtre impactÃ©s"

      # Discovery Service (Eureka) down
      - alert: DiscoveryServiceDown
        expr: up{job="discovery_service"} == 0
        for: 30s
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "ğŸ” Discovery Service DOWN - Impact critique!"
          description: "Eureka est indisponible - la dÃ©couverte de services est compromise"

      # Gateway down
      - alert: GatewayDown
        expr: up{job="gateway"} == 0
        for: 30s
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "ğŸšª API Gateway DOWN - AccÃ¨s externe impossible!"
          description: "La passerelle API est indisponible - les clients ne peuvent plus accÃ©der aux services"

  # ========================================
  # ALERTES SERVICES MÃ‰TIER
  # ========================================
  - name: business_services_alerts
    rules:
      # Service mÃ©tier critique down
      - alert: CriticalBusinessServiceDown
        expr: up{service_type="business"} == 0
        for: 1m
        labels:
          severity: critical
          team: development
        annotations:
          summary: "ğŸ’¼ Service mÃ©tier {{ $labels.job }} DOWN"
          description: "Le service mÃ©tier {{ $labels.application }} est indisponible"

      # Incidents en cours non traitÃ©s (exemple)
      - alert: UnprocessedIncidents
        expr: incident_queue_size > 10
        for: 5m
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "ğŸ“‹ Incidents non traitÃ©s accumulent"
          description: "{{ $value }} incidents en attente de traitement"

  # ========================================
  # ALERTES MESSAGING (MQTT)
  # ========================================
  - name: messaging_alerts
    rules:
      # MQTT Service down
      - alert: MqttServiceDown
        expr: up{job="mqtt_service"} == 0
        for: 1m
        labels:
          severity: critical
          team: integration
        annotations:
          summary: "ğŸ“¡ Service MQTT DOWN"
          description: "Le service MQTT est indisponible - communication IoT compromise"

      # MQTT Broker down
      - alert: MqttBrokerDown
        expr: up{job="mqtt_broker"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "ğŸ¢ MQTT Broker DOWN"
          description: "Le broker Mosquitto est indisponible"

  # ========================================
  # ALERTES SÃ‰CURITÃ‰
  # ========================================
  - name: security_alerts
    rules:
      # Keycloak down
      - alert: KeycloakDown
        expr: up{job="keycloak"} == 0
        for: 1m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "ğŸ” Keycloak DOWN - Authentification compromise!"
          description: "Le serveur d'authentification Keycloak est indisponible"

      # Trop de tentatives d'authentification Ã©chouÃ©es
      - alert: HighAuthenticationFailures
        expr: rate(keycloak_login_failures_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "ğŸš¨ Tentatives d'auth Ã©chouÃ©es Ã©levÃ©es"
          description: "{{ $value }} tentatives d'authentification Ã©chouÃ©es par seconde"