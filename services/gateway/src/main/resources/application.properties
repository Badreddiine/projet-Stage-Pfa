# ================================
# GATEWAY APPLICATION CONFIGURATION
# ================================
spring.application.name=gateway
server.port=8080
spring.main.web-application-type=reactive
spring.cloud.gateway.enabled=true
spring.main.allow-circular-references=false
server.ssl.enabled=false

# ================================
# EUREKA CLIENT CONFIGURATION
# ================================
eureka.client.service-url.defaultZone=http://admin:admin123@discovery-service:8761/eureka/
eureka.client.register-with-eureka=true
eureka.client.fetch-registry=true
eureka.client.enabled=true
spring.cloud.discovery.enabled=true

# Instance Configuration
eureka.instance.prefer-ip-address=false
eureka.instance.hostname=gateway
eureka.instance.instance-id=${spring.application.name}:${server.port}
eureka.instance.lease-renewal-interval-in-seconds=30
eureka.instance.lease-expiration-duration-in-seconds=90
eureka.instance.health-check-url-path=/actuator/health
eureka.instance.status-page-url-path=/actuator/info

# ================================
# KEYCLOAK CONFIGURATION - CORRIGÉE
# ================================
keycloak.internal.base-url=http://keycloak:8080
keycloak.external.base-url=http://localhost:8181

# CORRECTION : Utiliser l'URL interne pour la validation JWT
spring.security.oauth2.resourceserver.jwt.issuer-uri=${keycloak.internal.base-url}/realms/auth-service-realm
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${keycloak.internal.base-url}/realms/auth-service-realm/protocol/openid-connect/certs

# Configuration des audiences supportées
spring.security.oauth2.resourceserver.jwt.audiences=account,frontend-client,gateway-client

# Configuration du client OAuth2 (pour le frontend)
spring.security.oauth2.client.registration.keycloak.client-id=frontend-client
spring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.keycloak.scope=openid,profile,email
spring.security.oauth2.client.registration.keycloak.redirect-uri=http://localhost:4200/login/oauth2/code/keycloak

# URLs externes pour l'interaction client (navigateur)
spring.security.oauth2.client.provider.keycloak.authorization-uri=${keycloak.external.base-url}/realms/auth-service-realm/protocol/openid-connect/auth
spring.security.oauth2.client.provider.keycloak.token-uri=${keycloak.external.base-url}/realms/auth-service-realm/protocol/openid-connect/token

# URLs internes pour la communication inter-services
spring.security.oauth2.client.provider.keycloak.user-info-uri=${keycloak.internal.base-url}/realms/auth-service-realm/protocol/openid-connect/userinfo
spring.security.oauth2.client.provider.keycloak.jwk-set-uri=${keycloak.internal.base-url}/realms/auth-service-realm/protocol/openid-connect/certs
spring.security.oauth2.client.provider.keycloak.user-name-attribute=preferred_username

# Configuration Keycloak additionnelle
keycloak.logout-uri=${keycloak.external.base-url}/realms/auth-service-realm/protocol/openid-connect/logout
frontend.redirect-uri=http://localhost:4200
keycloak.auth-server-url=http://keycloak:8080
keycloak.realm=auth-service-realm
keycloak.resource=gateway-client
keycloak.credentials.secret=xPqJLYh4AdzthFiAwZnM1826CJFaPDaj

# ================================
# GATEWAY ROUTES CONFIGURATION
# ================================
# --- Infrastructure Routes ---
spring.cloud.gateway.routes[0].id=eureka-ui
spring.cloud.gateway.routes[0].uri=http://discovery-service:8761
spring.cloud.gateway.routes[0].predicates[0]=Path=/eureka/**

spring.cloud.gateway.routes[1].id=keycloak-auth
spring.cloud.gateway.routes[1].uri=http://keycloak:8080
spring.cloud.gateway.routes[1].predicates[0]=Path=/realms/**

# --- Service API Routes ---
spring.cloud.gateway.routes[2].id=user-service-api
spring.cloud.gateway.routes[2].uri=lb://USER-SERVICE
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/users/**

spring.cloud.gateway.routes[3].id=authentication-service-api
spring.cloud.gateway.routes[3].uri=lb://AUTHENTICATION-SERVICE
spring.cloud.gateway.routes[3].predicates[0]=Path=/api/auth/**

spring.cloud.gateway.routes[4].id=project-service-api
spring.cloud.gateway.routes[4].uri=lb://PROJECT-SERVICE
spring.cloud.gateway.routes[4].predicates[0]=Path=/api/projects/**

spring.cloud.gateway.routes[5].id=equipment-service-api
spring.cloud.gateway.routes[5].uri=lb://EQUIPMENT-SERVICE
spring.cloud.gateway.routes[5].predicates[0]=Path=/api/equipments/**, /api/alertes/**, /api/donnees-capteur/**, /api/regles-seuil/**

spring.cloud.gateway.routes[6].id=notification-service-api
spring.cloud.gateway.routes[6].uri=lb://NOTIFICATION-SERVICE
spring.cloud.gateway.routes[6].predicates[0]=Path=/api/notifications/**

spring.cloud.gateway.routes[7].id=incident-service-api
spring.cloud.gateway.routes[7].uri=lb://INCIDENT-SERVICE
spring.cloud.gateway.routes[7].predicates[0]=Path=/api/incidents/**

spring.cloud.gateway.routes[8].id=analysis-service-api
spring.cloud.gateway.routes[8].uri=lb://ANALYSIS-SERVICE
spring.cloud.gateway.routes[8].predicates[0]=Path=/api/analysis/**

spring.cloud.gateway.routes[9].id=mqtt-service-api
spring.cloud.gateway.routes[9].uri=lb://MQTT-SERVICE
spring.cloud.gateway.routes[9].predicates[0]=Path=/api/mqtt/**

# --- Swagger Doc Routes ---
spring.cloud.gateway.routes[10].id=user-service-docs
spring.cloud.gateway.routes[10].uri=lb://USER-SERVICE
spring.cloud.gateway.routes[10].predicates[0]=Path=/user-service/v3/api-docs/**
spring.cloud.gateway.routes[10].filters[0]=RewritePath=/user-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[11].id=authentication-service-docs
spring.cloud.gateway.routes[11].uri=lb://AUTHENTICATION-SERVICE
spring.cloud.gateway.routes[11].predicates[0]=Path=/authentication-service/v3/api-docs/**
spring.cloud.gateway.routes[11].filters[0]=RewritePath=/authentication-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[12].id=project-service-docs
spring.cloud.gateway.routes[12].uri=lb://PROJECT-SERVICE
spring.cloud.gateway.routes[12].predicates[0]=Path=/project-service/v3/api-docs/**
spring.cloud.gateway.routes[12].filters[0]=RewritePath=/project-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[13].id=equipment-service-docs
spring.cloud.gateway.routes[13].uri=lb://EQUIPMENT-SERVICE
spring.cloud.gateway.routes[13].predicates[0]=Path=/equipment-service/v3/api-docs/**
spring.cloud.gateway.routes[13].filters[0]=RewritePath=/equipment-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[14].id=notification-service-docs
spring.cloud.gateway.routes[14].uri=lb://NOTIFICATION-SERVICE
spring.cloud.gateway.routes[14].predicates[0]=Path=/notification-service/v3/api-docs/**
spring.cloud.gateway.routes[14].filters[0]=RewritePath=/notification-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[15].id=incident-service-docs
spring.cloud.gateway.routes[15].uri=lb://INCIDENT-SERVICE
spring.cloud.gateway.routes[15].predicates[0]=Path=/incident-service/v3/api-docs/**
spring.cloud.gateway.routes[15].filters[0]=RewritePath=/incident-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[16].id=analysis-service-docs
spring.cloud.gateway.routes[16].uri=lb://ANALYSIS-SERVICE
spring.cloud.gateway.routes[16].predicates[0]=Path=/analysis-service/v3/api-docs/**
spring.cloud.gateway.routes[16].filters[0]=RewritePath=/analysis-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[17].id=mqtt-service-docs
spring.cloud.gateway.routes[17].uri=lb://MQTT-SERVICE
spring.cloud.gateway.routes[17].predicates[0]=Path=/mqtt-service/v3/api-docs/**
spring.cloud.gateway.routes[17].filters[0]=RewritePath=/mqtt-service/v3/api-docs, /v3/api-docs

spring.cloud.gateway.routes[18].id=config-service-docs
spring.cloud.gateway.routes[18].uri=lb://CONFIG-SERVICE
spring.cloud.gateway.routes[18].predicates[0]=Path=/config-service/v3/api-docs/**
spring.cloud.gateway.routes[18].filters[0]=RewritePath=/config-service/v3/api-docs, /v3/api-docs

# ================================
# SWAGGER & DISCOVERY CONFIGURATION
# ================================
spring.cloud.gateway.discovery.locator.enabled=false
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.api-docs.enabled=true
springdoc.swagger-ui.use-root-path=true
springdoc.swagger-ui.config-url=/v3/api-docs/swagger-config
springdoc.swagger-ui.disable-swagger-default-url=true

# ================================
# CORS, FILTERS, HTTP, LOAD BALANCER, ETC.
# ================================
spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=http://localhost:4200,http://localhost:8080,http://localhost:3000,http://localhost:8181
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=GET,POST,PUT,DELETE,OPTIONS,PATCH
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].max-age=3600

spring.cloud.gateway.default-filters[0]=DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
spring.cloud.gateway.default-filters[1]=AddResponseHeader=X-Response-Gateway, SDSGPI-Gateway

spring.cloud.gateway.httpclient.connect-timeout=30000
spring.cloud.gateway.httpclient.response-timeout=PT60S
spring.cloud.gateway.httpclient.compression=true
spring.cloud.gateway.httpclient.pool.type=elastic
spring.cloud.gateway.httpclient.pool.max-connections=1000
spring.cloud.gateway.httpclient.pool.max-idle-time=PT30S
spring.cloud.gateway.httpclient.pool.max-life-time=PT120S
spring.cloud.gateway.httpclient.pool.acquire-timeout=60000
spring.cloud.gateway.httpclient.wiretap=false
spring.cloud.gateway.httpclient.ssl.use-insecure-trust-manager=true
spring.cloud.gateway.httpclient.ssl.handshake-timeout=PT10S
spring.cloud.gateway.httpclient.ssl.close-notify-flush-timeout=PT3S
spring.cloud.gateway.httpclient.ssl.close-notify-read-timeout=PT0S

spring.cloud.loadbalancer.ribbon.enabled=false
spring.cloud.loadbalancer.retry.enabled=true
spring.cloud.loadbalancer.health-check.initial-delay=PT0S
spring.cloud.gateway.loadbalancer.health-check.interval=PT25S

spring.codec.max-in-memory-size=2MB
spring.webflux.multipart.max-in-memory-size=2MB
spring.webflux.multipart.max-disk-usage-per-part=20MB

spring.cloud.gateway.forwarded.enabled=true
spring.cloud.gateway.x-forwarded.enabled=true
spring.cloud.gateway.x-forwarded.for-enabled=true
spring.cloud.gateway.x-forwarded.host-enabled=true
spring.cloud.gateway.x-forwarded.port-enabled=true
spring.cloud.gateway.x-forwarded.proto-enabled=true
spring.cloud.gateway.x-forwarded.prefix-enabled=true

# ================================
# ACTUATOR & MANAGEMENT CONFIGURATION
# ================================
management.endpoints.web.exposure.include=health,info,gateway,prometheus,metrics,eureka
management.endpoint.health.show-details=always
management.endpoint.gateway.enabled=true
management.endpoints.web.base-path=/actuator
management.security.enabled=false
management.health.eureka.enabled=true
management.endpoint.health.probes.enabled=true
management.health.livenessstate.enabled=true
management.health.readinessstate.enabled=true
management.endpoint.prometheus.enabled=true
management.endpoint.metrics.enabled=true
management.endpoints.web.cors.allowed-origins=*
management.endpoints.web.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
management.endpoints.web.cors.allowed-headers=*

management.prometheus.metrics.export.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.percentiles.http.server.requests=0.5,0.95,0.99
management.metrics.tags.application=${spring.application.name}

# ================================
# RESILIENCE4J CONFIGURATION
# ================================
resilience4j.circuitbreaker.instances.default.registerHealthIndicator=false
resilience4j.retry.instances.default.maxAttempts=3
resilience4j.retry.instances.default.waitDuration=PT1S
resilience4j.timelimiter.instances.default.timeoutDuration=PT30S

# ================================
# LOGGING CONFIGURATION
# ================================
logging.level.org.springframework.cloud.gateway=INFO
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web.reactive=INFO
logging.level.org.springframework.boot.actuator=INFO
logging.level.com.netflix.eureka=INFO
logging.level.com.netflix.discovery=INFO
logging.level.reactor.netty=INFO
logging.level.io.netty=INFO
logging.level.root=INFO
logging.level.org.springdoc=DEBUG
logging.level.org.springframework.security.oauth2=DEBUG

logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# ================================
# SERVER ERROR CONFIGURATION
# ================================
server.error.whitelabel.enabled=true
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=on_param
server.error.include-exception=false

# ================================
# SECURITY CONFIGURATION
# ================================
spring.security.user.name=admin
spring.security.user.password=admin123
spring.security.user.roles=ACTUATOR

# ================================
# ADDITIONAL CONFIGURATION
# ================================
spring.profiles.active=docker
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC
server.tomcat.connection-timeout=20000
server.tomcat.keep-alive-timeout=15000